<!doctype html>
<html lang="en" ng-app='TimeTrack'>
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>  

    <!-- JAVASCRIPT (assets/javascripts) -->
    <%= javascript_include_tag "project_selectors" %>
    <%= javascript_include_tag "modals_dropdowns" %>
    <%= javascript_include_tag "spa_functionality" %>
  </head>
  <body>

  <!-- post messages from controller go here -->
  <p id="notice"><%= notice %></p>

  <!-- BOOTSTRAP - NAVBAR -->
  <nav class="navbar navbar-light bg-light">
    <div class="btn-group">
      <button id="tracker-index-nav-btn" type="button" class="btn btn-primary nav-button" data-toggle="dropdown"><%= fa_icon('bars')%></button>
      <div class="dropdown-menu">
        <%= link_to "Trackers for Month", "month_index", method: :get, id: "tracker-index-nav-month-tracker-link" %>
        <br><%= link_to "Project List", :controller => "projects", :action => "index" %>
        <br><%= link_to "NT Process", :method => "post", :controller => "daily_tasks", :action => "nightly_task_processing" %>

      </div>
    </div>

    <span class="navbar-brand mb-0 h1">TimeTrack</span>

    <div>
      <%= Time.now.strftime('%m-%d-%Y')%><br>
      <%= Time.now.strftime('%H:%M')%>
    <div>
  </nav>


<!-- /////////////////////////////////////////////////// -->
<!-- ////////// DAILY TASKS AND WEEKLY GOALS /////////// -->
<!-- /////////////////////////////////////////////////// -->

    <!-- Modal window for 'New' and 'Edit' task and goal functionality -->
    <div id="task-goal-modal-window" class="modal hide fade" role="dialog" aria-labelledby="task-goal-modal-window" aria-hidden="true">
      <div id="modal-dialog" class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <i class="fas fa-times" data-dismiss="modal" onclick="modalXClose()"></i>
            <h4 class="modal-title" id="task-goal-modal-title"></h4>
          </div>
          <div id="task-goal-modal-window-body" class="modal-body">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>


    <div id="goals-tasks" class="rounded" ng-controller='TaskGoalContent'>
    
      <!-- link to trigger modal window for 'New' task and goal functionality -->
      <div id="task-goal-header" >
        <div id="task_goal_toggle_view">
          <h2 id="task-goal-header-text">Project Goals and Tasks</h2>
          <button id="today-tasks-btn" name="today-tasks-btn" type="button" class="goal-task-toggle-btn active-task-toggle-btn" onclick="taskGoalToggle('today');" >Today</button>
          <button id="weekly-goals-btn" type="button" class="goal-task-toggle-btn" onclick="taskGoalToggle('week');">This Week</button>
        </div>    
      </div> <!-- end #task-goal-header -->
        
      <div id="task-goal-content">

        <!-- DISPLAY TODAYS TASKS -->
        <div id="daily-tasks" class="">  
          
          <%= link_to new_daily_task_path, class: 'btn add-new-btn', remote: true do %>
            <i class="fas fa-plus"></i>
          <% end %>  
          <div class="container-fluid">
            <div class="row">
              <% todays_tasks = get_todays_tasks %> <!-- return all tasks marked true for 'is_daily_task' -->
              <% todays_tasks.each do |task| %> <!-- loop through all daily tasks -->
                <% unless task.completed %>
                  <div class="col-md-4 col-sm-6 daily-task-cat">
                    <button type="button" class="nav-button daily-task-btn rounded" data-toggle="dropdown">
                      <span class="task-project"><%= task.project.name %></span>
                      <span class="daily-task"><%= task.name %></span> 
                      <i class="far fa-clock today-task-clock"></i>
                    </button> 
                    <div id="" class="dropdown-menu">
                      <button><%= link_to 'Edit Task', {:controller => "daily_tasks", :action => "edit", :id => task.id,}, :class => "task-dropdown-item", remote: true %></button> <!--link to modal window for 'Edit' task functionality -->
                      <button><% if task.is_today_task == true then %>
                        <%= link_to "Remove from Today's Tasks", {:controller => "daily_tasks", :action => "remove_today_task", :daily_task => task.id}, :class => "task-dropdown-item" %>
                      <% else %>
                        <%= link_to "Mark for Today's Tasks", {:controller => "daily_tasks", :action => "mark_today_task", :daily_task => task.id}, :class => "task-dropdown-item" %>
                      <% end %></button>
                      <button><%= link_to "Complete Task", complete_task_path(task_id: task.id), :class=>"task-dropdown-item" %></button>
                      <button><%= link_to "Add Tracker", create_task_tracker_path(task_id: task.id), :class=>"task-dropdown-item", remote: true %></button>
                      <button><%= link_to "Delete Task", {:controller => "daily_tasks", :action => "delete_task", :daily_task => task.id}, data: {confirm: "Are you sure you want to delete this Daily Task?"}, :class=>"task-dropdown-item"  %></button>

                    </div> <!-- end dropdown-menu -->  
                  </div> <!-- end col-md-4 -->
                <% else %>
                  <% if task.active %>
                    <div class="col-md-4 col-sm-6 daily-task-cat">
                      <div class="weekly-goal-completed rounded">
                        <div class="completed-check"><%= fa_icon('check-circle') %></div>
                        <span class="completed-task-project">
                          <% if !task.weekly_goal.nil? then %>
                            <% if !task.weekly_goal.project.nil? then %>
                              <%= task.weekly_goal.project.name %>
                            <% end %>
                          <% end %>
                        </span>
                        <span class="completed-daily-task"><%= task.name %></span>
                      </div> <!-- end #completed_check -->  
                    </div> <!-- end col-md-4 -->
                  <% end %>
                <% end %>
              <% end %>
            </div> <!-- row -->
          </div> <!-- container -->
        </div> <!-- end daily_tasks -->   


        <!-- DISPLAY WEEKLY GOALS -->

        <div id="weekly-goals" class="inactive-task-content-toggle">
        <%= link_to new_weekly_goal_path, class: 'btn add-new-btn', remote: true do %>
          <i class="fas fa-plus"></i>
        <% end %>  
          <!-- <div class="container-fluid"> -->
          <div id="weekly-goal-container">
            <!-- <div class="row"> -->
            <% @weekly_goal_categories.each do |category| %> <!--loop through all weekly goals categories. @weekly_goal_categories set in tracker controller -->
              <% weekly_goals = get_weekly_goals(category) %> <!-- for each category, find the associated goals. get_weekly_goals lives in tracker controller-->
              <% weekly_goals.each do |goal| %> <!-- loop through all weekly goals -->
                  <!-- WEEKLY TASK GRID -->
                <% if goal.active_task_num > 0 then %>
                  <!-- <div class="weekly-goal-content"> -->
                  <!-- <div class="weekly-goal-content row"> -->

                    <!-- <div class="row"> -->
                      <!-- <div class="weekly-goal-header col-sm-12"> -->
                        
                       <!-- <% if goal.completed then %>
                          <i class="fas fa-check-circle fa-5x"></i>--><!-- display closed circle check if completed -->
                       <!-- <% end %> -->
                  <% if goal.active_task_num == 3 then %>
                    <div id="weekly-goal-<%= goal.id %>" class="weekly-goal-item-full weekly-goal-content rounded">
                  <% elsif goal.active_task_num == 2 then %>
                    <div id="weekly-goal-<%= goal.id %>" class="weekly-goal-item-half weekly-goal-content rounded">
                  <% elsif goal.active_task_num == 1 then %>
                    <div id="weekly-goal-<%= goal.id %>" class="weekly-goal-item-third weekly-goal-content rounded">
                  <% end %>
                      <div class="weekly-goal-inset rounded">
                        <!-- <div class="daily-task-menu">
                          <button type="button" class="nav-button" data-toggle="dropdown">
                            <%= fa_icon('bars')%>
                          </button>
                          <div class="dropdown-menu">
                            <button><%= link_to "Complete Goal", {:controller => 'weekly_goals', :action => "complete_goal", :goal_id => goal.id}%></button>
                            <button><%= link_to 'Edit Goal', {:controller => "weekly_goals", :action => "edit", :id => goal.id}, remote: true %></button> link to modal window for 'Edit' goal functionality 
                            <button><%= link_to 'New Daily Task', {:controller => "weekly_goals", :action => "new_inherited_task", :weekly_goal => goal.id}, remote: true %></button>
                            <button><%= link_to "Delete Goal", {:controller => "weekly_goals", :action => "delete_goal", :goal_id => goal.id}, data: {confirm: "Are you sure you want to delete this Weekly Goal?"} %></button>
                            <button>View Weekly Goals with no Tasks</button>
                          </div> 
                        </div> -->

                        <span class="task-cat-title"><%= category %></span>
                        <span class="weekly-goal-name"><%= goal.name %></span>  
                        <span class="task-project"><%= goal.project.name %></span>                     
                       

                        <!-- ASSOCIATED DAILY TASKS -->
                        <% daily_tasks = get_daily_tasks(goal.project.id) %> <!-- for each weekly task, find the associated daily tasks. get_daily_tasks lives in tracker controller -->
                        <div class="weekly-goal-task-container"> 
                          <% daily_tasks.each do |task| %> <!-- loop through all daily tasks -->
                          
                            <% unless task.completed %>
                              <div class="weekly-goal-item-third daily-task-cat">
                                <button type="button" class="nav-button daily-task-btn rounded" data-toggle="dropdown">
                                  <span class="task-project"><%= task.weekly_goal.project.name %></span>
                                  <span class="daily-task"><%= task.name %></span> 
                                  <% if task.is_today_task == true then %>
                                    <i class="far fa-clock today-task-clock"></i><!-- display clock identifying a task that is marked for today -->
                                  <% end %>
                                </button> 
                                <div class="dropdown-menu">
                                  <button><%= link_to 'Edit Task', {:controller => "daily_tasks", :action => "edit", :id => task.id}, remote: true %></button><!--link to modal window for 'Edit' task functionality -->
                                  <button><%= link_to "Mark for Today's Tasks", {:controller => "daily_tasks", :action => "mark_today_task", :daily_task => task.id} %></button>
                                  <button><%= link_to "Complete Task", {:controller => "daily_tasks", :action => "complete_task", :task_id => task.id} %></button>
                                  <button><%= link_to "Delete Task", {:controller => "daily_tasks", :action => "delete_task", :task_id => task.id}, data: {confirm: "Are you sure you want to delete this task?"}  %></button>

                                </div> <!-- end dropdown-menu -->







                                <!-- <span class="daily-task"><%= task.name %></span> 
                                <% if task.is_today_task == true then %>
                                  <i class="far fa-clock today-task-clock"></i>--> <!-- display clock identifying a task that is marked for today -->
                                <!--<% end %> -->
                              </div>
                            <% else %>
                              <div id="weekly-goal-completed" class="weekly-goal-item-third weekly-goal-completed">
                                <div class="completed-check"><%= fa_icon('check-circle') %></div>
                                <span class="completed-task-project"><%= task.weekly_goal.project.name %></span>
                                <span class="completed-daily-task"><%= task.name %></span>
                              </div> <!-- end weekly-goal-completed -->
                            <% end %>
                          <% end %>
                        </div>
                      </div>  <!-- end weekly-goal-inset -->
                    </div> <!-- end weekly-goal-item-* -->
                <% end %>
              <% end %>
            <% end %>
          </div> <!-- end weekly-goal-container -->
        </div> <!-- end weekly-goals -->     
      </div> <!-- end #task_goal_content -->
    </div> <!-- end .goals-tasks -->


<!-- /////////////////////////////////////////////////// -->
<!-- /////////////////// TRACKERS ////////////////////// -->
<!-- /////////////////////////////////////////////////// -->

    <!-- Modal window for 'New' and 'Edit' tracker functionality -->
    <div id="tracker-modal-window" class="modal hide fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div id="modal-dialog" class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="tracker-modal-title">New Tracker</h4>
            <i class="fas fa-times" data-dismiss="modal" onclick="modalXClose()"></i>
          </div>
          <div id="tracker-modal-window-body" class="modal-body">
            <!-- form dynamically added in edit.js.erb or new.js.erb -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div> <!-- end tracker-modal-window -->

    <!-- Tracker Table -->
    <table id="daily-trackers" class="table">
      <div class="table-caption">
        <h2 id="tracker-title">Today's Trackers <%= link_to new_tracker_path, id: 'index-new-tracker', class: 'btn add-new-btn', remote: true do %>
        <i class="fas fa-plus"></i>
      <% end %></h2>
      </div>
      <thead>
        <tr>
          <th>Day</th>
          <th>Project Umbrella</th>
          <th>Project</th>
          <th>Weekly Goal</th>
          <th>Daily Task</th>
          <th>Description</th>
          <th>Hours</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th></th>
          <th></th>
      </thead>
      <tbody id="idx-trackers" >
        <% curr_day = Time.now.day %>
        <% @day_trackers = get_days_trackers(curr_day) %> <!-- return an array of trackers for day i -->
        <% if @day_trackers.empty? then %> <!-- if array is empty display 'no info' line -->
          <tr class="empty-day">
            <% i_day = Date.new(@year, @month, curr_day) %>
            <div class="td"><%= i_day.strftime("%a #{i_day.day.ordinalize}") %></div>
            <div class="td">No Trackers Logged :(</div>
          </tr>
        <% else %> <!-- if array is not empty, format and show all trackers for the day -->
          <% @day_trackers.each do |tracker| %>
            <tr id=<%=tracker.id%>>
              <td><%= tracker.date.strftime("%a #{tracker.date.day.ordinalize}") %></td>
              <td>
                <% if !tracker.project_umbrella_id.nil? then %> <!-- first check for unlinked project umbrella-->
                  <%= ProjectUmbrella.find(tracker.project_umbrella_id).name %>
                <% else %> <!-- if not stored directly, get project umbrella through linking -->
                  <% if !tracker.daily_task.nil? then %> 
                    <% if !tracker.daily_task.weekly_goal.nil? then %>
                      <% if !tracker.daily_task.weekly_goal.project.nil? then %>
                        <% if !tracker.daily_task.weekly_goal.project.project_umbrella.nil? then %>
                          <%= tracker.daily_task.weekly_goal.project.project_umbrella.name %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if !tracker.project_id.nil? then %> <!-- first check for unlinked project umbrella-->
                  <%= Project.find(tracker.project_id).name %>
                <% else %> <!-- if not stored directly, get project umbrella through linking -->
                  <% if !tracker.daily_task.nil? then %>
                    <% if !tracker.daily_task.weekly_goal.nil? then %>
                      <% if !tracker.daily_task.weekly_goal.project.nil? then %>
                        <%= tracker.daily_task.weekly_goal.project.name %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if !tracker.daily_task.nil? then %>
                  <% if !tracker.daily_task.weekly_goal.nil? then %>
                    <%= tracker.daily_task.weekly_goal.name %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if !tracker.daily_task.nil? then %>
                  <%= tracker.daily_task.name %>
                <% end %>
              </td>
              <td><%= tracker.description %></td>
              <td><%= tracker.hours %></td>
              <td><%= tracker.start_time.strftime("%H:%M") %></td>
              <td><%= tracker.end_time.strftime("%H:%M") %></td>
              <td><%= link_to 'Edit', edit_tracker_path(tracker.id), remote: true %></td>
              <td><%= link_to 'Destroy', tracker, method: :delete, data: { confirm: 'Are you sure?' } %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody> <!-- end idx_trackers -->
    </table> <!-- end daily-trackers -->
  <!-- </div> -->
  </body>
</html>