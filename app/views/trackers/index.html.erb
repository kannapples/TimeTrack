<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>  

    <!-- JAVASCRIPT (assets/javascripts) -->
    <%= javascript_include_tag "project_selectors" %>
    <%= javascript_include_tag "modals_dropdowns" %>
  </head>
  <body>

  <!-- post messages from controller go here -->
  <p id="notice"><%= notice %></p>

  <!-- BOOTSTRAP - NAVBAR -->
  <nav class="navbar navbar-light bg-light">
    <div class="btn-group">
      <button type="button" class="btn btn-primary nav-button" data-toggle="dropdown"><%= fa_icon('bars')%></button>
      <div class="dropdown-menu">
        <%= link_to "Trackers for Month", "month_index" %>
        <br><%= link_to "Project List", :controller => "projects", :action => "index" %>
        <br><%= link_to "NT Process", :method => "post", :controller => "scrum_tasks", :action => "nightly_task_processing"  %>

      </div>
    </div>

    <span class="navbar-brand mb-0 h1">TimeTrack</span>

    <div>
      <%= Time.now.strftime('%m-%d-%Y')%><br>
      <%= Time.now.strftime('%H:%M')%>
    <div>
  </nav>
      
  <!--<%= button_to "NT Process",  {:controller => "scrum_tasks", :action => "nightly_task_processing"} %> -->



<!-- /////////////////////////////////////////////////// -->
<!-- ////////////////// SCRUM TASKS //////////////////// -->
<!-- /////////////////////////////////////////////////// -->

    <!-- Modal window for 'New' and 'Edit' scrum functionality -->
    <div id="scrum-modal-window" class="modal hide fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div id="modal-dialog" class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal">&times;</button>
            <h4 class="modal-title" id="scrum-modal-title"></h4>
          </div>
          <div id="scrum-modal-window-body" class="modal-body">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

<!--     <div id="nonmodal_content"> -->
    <div id="scrum_tasks" class="rounded">
      <!-- link to trigger modal window for 'New' scrum functionality -->
      <div id="scrum_toggle_view">
        <h2>Project Goals and Tasks</h2>
        <button id="scrum-today-tasks-btn" type="button" class="scrum-toggle-btn active-scrum-toggle-btn" onclick="toggleScrumView('today')">Today</button>
        <button id="scrum-weekly-tasks-btn" type="button" class="scrum-toggle-btn" onclick="toggleScrumView('week')">This Week</button>
      </div>
      <div id="daily_scrum_tasks" class="project-content">
        <h3 id="task_heading">Today's Tasks</h3>
        <div class="container-fluid">
          <div class="row">
            <% todays_tasks = get_todays_tasks %> <!-- return all tasks marked true for 'is_daily_task' -->
            <% todays_tasks.each do |task| %> <!-- loop through all daily tasks -->
              <% unless task.completed %>
                <div class="daily_task_cat col-md-4">
                  <button type="button" class="nav-button daily_task_btn" data-toggle="dropdown">
                    <span class="task_project"><%= task.project_module.name %></span>
                    <span class="daily_task"><%= task.name %></span> 
                    <i class="far fa-clock today-task-clock"></i>
                  </button> 
                  <div class="dropdown-menu">
                    <%= link_to 'Edit Task', {:controller => "scrum_tasks", :action => "edit", :id => task.id}, remote: true %> <!--link to modal window for 'Edit' scrum functionality -->
                    <br><% if task.is_daily_task == true then %>
                      <%= link_to "Remove from Today's Tasks", {:controller => "scrum_tasks", :action => "remove_today_task", :scrum_task => task.id} %>
                    <% else %>
                      <%= link_to "Mark for Today's Tasks", {:controller => "scrum_tasks", :action => "mark_today_task", :scrum_task => task.id} %>
                    <% end %>
                    <br><%= link_to "Complete Task", complete_task_path(task_id: task.id) %>
                    <br><%= link_to "Add Tracker", create_task_tracker_path(task_id: task.id), remote: true %>
                    <br><%= link_to "Delete Task", {:controller => "scrum_tasks", :action => "delete_task", :scrum_task => task.id}, data: {confirm: "Are you sure you want to delete this task?"}  %>

                  </div> <!-- end dropdown-menu -->  
                </div> <!-- end daily_task_cat -->
              <% else %>
                <div id="weekly_goal_completed" class="weekly_goal_completed col-sm-4">
                  <div id="completed_check"><%= fa_icon('check-circle') %></div>
                  <span class="completed_task_project"><%= task.project_module.project.name %></span>
                  <span class="completed_daily_task"><%= task.name %></span>
                </div> <!-- end weekly_goal_completed -->
              <% end %>
            <% end %>
          </div>
        </div>
      </div> <!-- end daily_scrum_tasks -->
      <div id="weekly_scrum_tasks" style="display:none">
        <h3 id="task_heading">This Week's Tasks <%= link_to new_scrum_task_path, class: 'btn add_new_btn', remote: true do %>
          <i class="fas fa-plus"></i>
        <% end %></h3>
        <div class="container-fluid">
          <div class="row">
            <% @weekly_goal_categories.each do |category| %> <!--loop through all weekly goals categories. @weekly_goal_categories set in tracker controller -->
              <% weekly_goals = get_weekly_goals(category) %> <!-- for each category, find the associated goals. get_weekly_goals lives in tracker controller-->
              <% weekly_goals.each do |goal| %> <!-- loop through all weekly goals -->
                  <!-- WEEKLY TASK GRID -->
                <div class="weekly_goal_cat col-sm-11 rounded">
                  <div class="row">
                    <div class="weekly_goal_header col-sm-12">
                      <div class="scrum_task_menu">
                        <button type="button" class="nav-button" data-toggle="dropdown">
                          <%= fa_icon('bars')%>
                        </button>
                        <div class="dropdown-menu">
                            <%= link_to "Complete Task", complete_task_path(goal.id) %>
                          <br><%= link_to 'Edit Task', {:controller => "scrum_tasks", :action => "edit", :id => goal.id}, remote: true %> <!--link to modal window for 'Edit' scrum functionality -->
                          <br><%= link_to 'New Daily Task', {:controller => "scrum_tasks", :action => "new_inherited_task", :weekly_goal => goal.id}, remote: true %>
                          <br><%= link_to "Delete Task", {:controller => "scrum_tasks", :action => "delete_task", :scrum_task => goal.id}, data: {confirm: "Are you sure you want to delete this task?"} %>
                        </div>
                      </div>
                      <% if goal.completed then %>
                        <i class="fas fa-check-circle fa-5x"></i><!-- display closed circle check if completed -->
                      <% end %>
                      <span class="weekly_goal"><%= goal.name %></span>  
                      <span class="task_project"><%= goal.project_module.project.name %></span>                     
                      <span class="task_cat_title"><%= category %></span>
                            
                      <!-- DAILY TASK GRID -->
                      <% daily_tasks = get_daily_tasks(goal.project_module.project.id) %> <!-- for each weekly task, find the associated daily tasks. get_daily_tasks lives in tracker controller -->
                      <div class="row">
                        <% daily_tasks.each do |task| %> <!-- loop through all daily tasks -->
                          <% unless task.completed %>
                            <div class="daily_task_cat col-md-4">
                              <button type="button" class="nav-button daily_task_btn" data-toggle="dropdown">
                                <span class="task_project"><%= task.project_module.name %></span>
                                <span class="daily_task"><%= task.name %></span> 
                                <% if task.is_daily_task == true then %>
                                  <i class="far fa-clock today-task-clock"></i> <!-- display clock identifying a task that is marked for today -->
                                <% end %>
                              </button> 
                              <div class="dropdown-menu">
                                <%= link_to 'Edit Task', {:controller => "scrum_tasks", :action => "edit", :id => task.id}, remote: true %> <!--link to modal window for 'Edit' scrum functionality -->
                                <br><%= link_to "Mark for Today's Tasks", {:controller => "scrum_tasks", :action => "mark_today_task", :scrum_task => task.id} %>
                                <br><%= link_to "Complete Task", complete_task_path(task.id) %>
                                <br><%= link_to "Delete Task", {:controller => "scrum_tasks", :action => "delete_task", :scrum_task => task.id}, data: {confirm: "Are you sure you want to delete this task?"}  %>

                              </div> <!-- end dropdown-menu -->  
                            </div> <!-- end daily_task_cat -->
                          <% else %>
                            <div id="weekly_goal_completed" class="weekly_goal_completed col-sm-4">
                              <div id="completed_check"><%= fa_icon('check-circle') %></div>
                              <span class="completed_task_project"><%= task.project_module.project.name %></span>
                              <span class="completed_daily_task"><%= task.name %></span>
                            </div> <!-- end weekly_goal_completed -->
                          <% end %>
                        <% end %>
                      </div> 
                    </div> <!-- end weekly_goal_header -->
                  </div>
                </div> <!-- end weekly_goal_cat -->
              <% end %>
            <% end %>
          </div> 
          <!-- UNASSOCIATED TASKS GRID -->
          <div class="row">
            <div class="weekly_goal_cat col-sm-11">
              <div class="row">
                <div class="weekly_goal_header col-sm-12">   
                  <span class="weekly_goal">Unassociated Tasks</span> 
                  <% unassoc_daily_tasks = get_unassoc_daily_tasks %> <!-- for each weekly task, find the associated daily tasks. get_daily_tasks lives in tracker controller -->
                  <div class="row"> 
                    <% unassoc_daily_tasks.each do |task| %> <!-- loop through all daily tasks -->
                      <% unless task.completed %> 
                        <div class="daily_task_cat col-md-4">
                          <button type="button" class="nav-button unassoc_task_btn" data-toggle="dropdown">
                            <span class="task_project">Umbrella: <%= task.project.project_umbrella.name %></span>
                            <span class="daily_task">Project: <%= task.project.name %></span>
                            <span class="daily_task">
                              Module: 
                              <% if !task.project_module.nil? then %>
                                <%= task.project_module.name %>
                              <% end %>
                            </span>
                            <span class="daily_task">Task: <%= task.name %></span>
                            <% if task.is_daily_task == true then %>
                              <i class="far fa-clock today-task-clock"></i> <!-- display clock identifying a task that is marked for today -->
                            <% end %>
                          </button> 
                          <div class="dropdown-menu">
                            <%= link_to 'Edit Task', {:controller => "scrum_tasks", :action => "edit", :id => task.id}, remote: true %> <!--link to modal window for 'Edit' scrum functionality -->
                            <br><%= link_to "Mark for Today's Tasks", {:controller => "scrum_tasks", :action => "mark_today_task", :scrum_task => task.id} %>
                            <br><%= link_to "Complete Task", complete_task_path(task.id) %>
                            <br><%= link_to "Delete Task", {:controller => "scrum_tasks", :action => "delete_task", :scrum_task => task.id}, data: {confirm: "Are you sure you want to delete this task?"}  %>
                          </div> <!-- end dropdown-menu -->   
                        </div>
                      <% else %>
                        <div class="weekly_goal_completed col-md-4">
                          <div id="completed_check"><%= fa_icon('check-circle') %></div>
                          <span class="completed_task_project"><%= task.project.name %></span>
                          <span class="completed_daily_task"><%= task.name %></span>
                        </div> <!-- end weekly_goal_completed -->
                      <% end %>
                    <% end %>
                  </div> 
                </div> <!-- end weekly_goal_header -->
              </div> 
            </div> <!-- end weekly_goal_cat -->
          </div>
        </div> 
      </div> <!-- end weekly_scrum_tasks -->
    </div> <!-- end scrum_tasks -->

<!-- /////////////////////////////////////////////////// -->
<!-- /////////////////// TRACKERS ////////////////////// -->
<!-- /////////////////////////////////////////////////// -->

    <!-- Modal window for 'New' and 'Edit' tracker functionality -->
    <div id="tracker-modal-window" class="modal hide fade" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
      <div id="modal-dialog" class="modal-dialog modal-sm" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h4 class="modal-title" id="tracker-modal-title">New Tracker</h4>
            <i class="fas fa-times" data-dismiss="modal" onclick="modalXClose()"></i>
          </div>
          <div id="tracker-modal-window-body" class="modal-body">
            <!-- form dynamically added in edit.js.erb or new.js.erb -->
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary">Save changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div> <!-- end scrum-modal-window -->

    <!-- Tracker Table -->
    <table id="daily_trackers" class="table">
      <div class="table_caption">
        <h2 id="tracker_title">Today's Trackers <%= link_to new_tracker_path, class: 'btn add_new_btn', remote: true do %>
        <i class="fas fa-plus"></i>
      <% end %></h2>
      </div>
      <thead>
        <tr>
          <th>Day</th>
          <th>Project Umbrella</th>
          <th>Project</th>
          <th>Project Module</th>
          <th>Scrum Task</th>
          <th>Description</th>
          <th>Hours</th>
          <th>Start Time</th>
          <th>End Time</th>
          <th>Payment</th>
          <th></th>
          <th></th>
      </thead>
      <tbody id="idx_trackers" >
        <% curr_day = Time.now.day %>
        <% @day_trackers = get_days_trackers(curr_day) %> <!-- return an array of trackers for day i -->
        <% if @day_trackers.empty? then %> <!-- if array is empty display 'no info' line -->
          <tr class="empty_day">
            <% i_day = Date.new(@year, @month, curr_day) %>
            <div class="td"><%= i_day.strftime("%a #{i_day.day.ordinalize}") %></div>
            <div class="td">No Trackers Logged :(</div>
          </tr>
        <% else %> <!-- if array is not empty, format and show all trackers for the day -->
          <% @day_trackers.each do |tracker| %>
            <tr id=<%=tracker.id%>>
              <td><%= tracker.date.strftime("%a #{tracker.date.day.ordinalize}") %></td>
              <td>
                <% if !tracker.project_umbrella_id.nil? then %> <!-- first check for unlinked project umbrella-->
                  <%= ProjectUmbrella.find(tracker.project_umbrella_id).name %>
                <% else %> <!-- if not stored directly, get project umbrella through linking -->
                  <% if !tracker.scrum_task.nil? then %> 
                    <% if !tracker.scrum_task.project_module.nil? then %>
                      <% if !tracker.scrum_task.project_module.project.nil? then %>
                        <% if !tracker.scrum_task.project_module.project.project_umbrella.nil? then %>
                          <%= tracker.scrum_task.project_module.project.project_umbrella.name %>
                        <% end %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if !tracker.project_id.nil? then %> <!-- first check for unlinked project umbrella-->
                  <%= Project.find(tracker.project_id).name %>
                <% else %> <!-- if not stored directly, get project umbrella through linking -->
                  <% if !tracker.scrum_task.nil? then %>
                    <% if !tracker.scrum_task.project_module.nil? then %>
                      <% if !tracker.scrum_task.project_module.project.nil? then %>
                        <%= tracker.scrum_task.project_module.project.name %>
                      <% end %>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if !tracker.scrum_task.nil? then %>
                  <% if !tracker.scrum_task.project_module.nil? then %>
                    <%= tracker.scrum_task.project_module.name %>
                  <% end %>
                <% end %>
              </td>
              <td>
                <% if !tracker.scrum_task.nil? then %>
                  <%= tracker.scrum_task.name %>
                <% end %>
              </td>
              <td><%= tracker.description %></td>
              <td><%= tracker.hours %></td>
              <td><%= tracker.start_time.strftime("%H:%M") %></td>
              <td><%= tracker.end_time.strftime("%H:%M") %></td>
              <td><%= tracker.payment %></td>
              <td><%= link_to 'Edit', edit_tracker_path(tracker.id), remote: true %></td>
              <td><%= link_to 'Destroy', tracker, method: :delete, data: { confirm: 'Are you sure?' } %></td>
            </tr>
          <% end %>
        <% end %>
      </tbody> <!-- end idx_trackers -->
    </table> <!-- end daily_trackers -->
    <!-- </div> end nonmodal-content -->
  <!-- </div> -->
  </body>
</html>